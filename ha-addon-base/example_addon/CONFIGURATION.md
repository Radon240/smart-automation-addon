# Configuration Management

The addon now supports dynamic configuration via Home Assistant's addon settings UI.

## How It Works

1. **Home Assistant Integration**: When you change settings in the addon's UI (add-ons → Adaptive Home Automations → Configuration), Home Assistant supervisor automatically saves them to `/data/options.json` inside the container.

2. **Automatic Loading**: On startup, the Flask service reads `/data/options.json` and applies the configuration.

3. **Dynamic Reload**: You can reload configuration at runtime using the `/api/config/reload` endpoint without restarting the addon.

## Configuration Parameters

All parameters are accessible through the Home Assistant UI:

| Parameter | Type | Default | Range | Description |
|-----------|------|---------|-------|-------------|
| `min_support` | integer | 5 | 1–100 | Minimum number of observations required to suggest an action |
| `min_confidence` | float | 0.6 | 0.0–1.0 | Minimum probability threshold for predictions (0=any, 1=100% certain) |
| `history_days` | integer | 7 | 1–365 | How many days of Home Assistant history to fetch for model training |
| `train_hour` | integer | 3 | 0–23 | Hour of day (24-hour format) when automatic nightly training runs |

### What Each Parameter Does

- **min_support**: Higher values = model ignores rare patterns, only suggests common habits
  - Example: if set to 10, a light must be turned on at least 10 times during a particular hour to be suggested
  
- **min_confidence**: Higher values = stricter predictions
  - Example: if set to 0.9, light must be on >90% of the time during that hour to be suggested
  - Suggested range: 0.4–0.8 (lower = more suggestions, higher = more confident predictions)

- **history_days**: More days = richer training data but slower training
  - 7 days: typical weekly patterns
  - 14–30 days: captures full month cycles and recurring patterns
  - 90+ days: long-term trends

- **train_hour**: When to automatically retrain the model
  - Example: `train_hour: 3` = model retrains every day at 3:00 AM
  - Use a quiet hour to minimize performance impact

## API Endpoints

### GET `/api/config`
Returns current configuration and training status:
```json
{
  "min_support": 5,
  "min_confidence": 0.6,
  "history_days": 7,
  "train_hour": 3,
  "last_trained": "2026-02-05T15:30:00",
  "training_in_progress": false,
  "last_training_samples": 1523
}
```

### POST `/api/config/reload`
Reloads configuration from `/data/options.json` without restarting:
```json
{
  "status": "ok",
  "message": "Configuration reloaded successfully",
  "config": {
    "min_support": 5,
    "min_confidence": 0.6,
    "history_days": 7,
    "train_hour": 3
  }
}
```

## Environment Variable Overrides

For local testing, you can set environment variables to override config file values:

```bash
export MIN_SUPPORT=10
export MIN_CONFIDENCE=0.7
export HISTORY_DAYS=14
export TRAIN_HOUR=2
python app/main.py
```

## Example: Tuning for Your Home

### Scenario 1: Too Many Suggestions (False Positives)
If the model suggests actions that don't make sense:
- **Increase `min_confidence`** to 0.7–0.8 (stricter)
- **Increase `min_support`** to 10–15 (require more observations)

### Scenario 2: Too Few Suggestions (Missing Patterns)
If the model doesn't find obvious patterns:
- **Decrease `min_confidence`** to 0.4–0.5 (more permissive)
- **Decrease `min_support`** to 3–5 (include more patterns)
- **Increase `history_days`** to 14–30 (more training data)

### Scenario 3: Training Takes Too Long
- **Decrease `history_days`** to 3–5 (less data to process)
- Schedule training at off-peak hours via `train_hour`

## File Structure

```
app/
├── config.py              # Configuration loading and management
├── main.py                # Flask service (reads config via config.py)
└── ml_model.py

data/
└── options.json           # Configuration values (auto-generated by HA, or use as template)
```

## Notes

- Changes via the Home Assistant UI take effect after calling `/api/config/reload` or restarting the addon
- The model is **not** automatically retrained when configuration changes — only when `/api/train` is called or at the scheduled `train_hour`
- For best results, use a week or more of history (`history_days >= 7`)
